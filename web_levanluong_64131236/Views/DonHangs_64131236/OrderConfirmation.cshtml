@model web_levanluong_64131236.Models.DonHang
@Html.AntiForgeryToken()
@{
    ViewBag.Title = "Chi tiết đơn hàng #" + Model.MaDH;
    Layout = "~/Views/Shared/_LayoutPage1.cshtml";
}

<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.0.18/sweetalert2.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.0.18/sweetalert2.all.min.js"></script>

<div class="container my-5">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <div class="mb-4">
                @if (Model.TrangThai == "Đã hủy")
                {
                    <i class="fas fa-times-circle text-danger" style="font-size: 48px;"></i>
                    <h2 class="mt-3 text-danger">Đơn hàng đã bị hủy</h2>
                }
                else
                {
                    <i class="fas fa-check-circle text-success" style="font-size: 48px;"></i>
                    <h2 class="mt-3 text-success">Đơn hàng #@Model.MaDH</h2>
                }
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Order Information -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Thông tin đơn hàng</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-3">
                            <strong><i class="far fa-calendar-alt me-2"></i>Ngày đặt:</strong>
                            <br>@Model.NgayDat.ToString("dd/MM/yyyy HH:mm")
                        </li>
                        <li class="mb-3">
                            <strong><i class="fas fa-money-bill-wave me-2"></i>Phương thức thanh toán:</strong>
                            <br>@Model.PhuongThucThanhToan
                        </li>
                        <li class="mb-3">
                            <strong><i class="fas fa-info-circle me-2"></i>Trạng thái:</strong><br>
                            @if (Model.TrangThai == "Đã hủy")
                            {
                                <span class="badge bg-danger">@Model.TrangThai</span>
                            }
                            else if (Model.TrangThai == "Đã xác nhận")
                            {
                                <span class="badge bg-success">@Model.TrangThai</span>
                            }
                            else
                            {
                                <span class="badge bg-warning">@Model.TrangThai</span>
                            }
                        </li>
                        <li class="mb-3">
                            <strong><i class="fas fa-truck me-2"></i>Trạng thái giao hàng:</strong><br>
                            <span class="badge bg-info">@Model.TrangThaiGiaoHang</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Customer Information -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-user me-2"></i>Thông tin khách hàng</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-3">
                            <strong><i class="fas fa-user me-2"></i>Tên khách hàng:</strong>
                            <br>@Model.KhachHang.TenKH
                        </li>
                        <li class="mb-3">
                            <strong><i class="fas fa-phone me-2"></i>Số điện thoại:</strong>
                            <br>@Model.KhachHang.SDT_KH
                        </li>
                        <li class="mb-3">
                            <strong><i class="fas fa-envelope me-2"></i>Email:</strong>
                            <br>@Model.KhachHang.Email
                        </li>
                        <li class="mb-3">
                            <strong><i class="fas fa-map-marker-alt me-2"></i>Địa chỉ:</strong>
                            <br>@Model.KhachHang.DiaChi
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-tasks me-2"></i>Thao tác</h5>
                </div>
                <div class="card-body d-flex flex-column">
                    @if (Model.TrangThai == "Chờ xác nhận")
                    {
                        <button class="btn btn-danger mb-3" onclick="huyDonHang(@Model.MaDH)">
                            <i class="fas fa-times-circle me-2"></i>Hủy đơn hàng
                        </button>
                    }

                    @if (Session["username"] != null && (bool?)Session["Admin"] == true)
                    {
                        <button class="btn btn-success mb-3" onclick="xacNhanDonHang(@Model.MaDH)">
                            <i class="fas fa-check-circle me-2"></i>Xác nhận đơn hàng
                        </button>
                    }

                    <a href="@Url.Action("Categories", "LoaiHangs_64131236")" class="btn btn-primary mt-auto">
                        <i class="fas fa-home me-2"></i>Về trang chủ
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details -->
    <div class="card shadow-sm mt-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Chi tiết đơn hàng</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Sản phẩm</th>
                            <th class="text-center" style="width: 120px;">Số lượng</th>
                            <th class="text-end" style="width: 150px;">Đơn giá</th>
                            <th class="text-end" style="width: 150px;">Thành tiền</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.ChiTietDonHangs)
                        {
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="~/img/@item.HangHoa.AnhHH"
                                             alt="@item.HangHoa.TenHH"
                                             class="img-thumbnail me-3"
                                             style="width: 60px; height: 60px; object-fit: cover;">
                                        <div>
                                            <h6 class="mb-1">@item.HangHoa.TenHH</h6>
                                          
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center align-middle">@item.SoLuong</td>
                                <td class="text-end align-middle">@item.DonGia.ToString("N0") đ</td>
                                <td class="text-end align-middle">@((item.SoLuong * item.DonGia).ToString("N0")) đ</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <td colspan="3" class="text-end"><strong>Tổng tiền sản phẩm:</strong></td>
                            <td class="text-end">@Model.ChiTietDonHangs.Sum(ct => ct.SoLuong * ct.DonGia).ToString("N0") đ</td>
                        </tr>
                        @if (Model.Discount != null)
                        {
                            <tr>
                                <td colspan="3" class="text-end text-danger">
                                    <strong>Giảm giá (@Model.Discount.TenGiamGia):</strong>
                                </td>
                                <td class="text-end text-danger">-@Model.Discount.GiaTriGiamGia.ToString("N0") đ</td>
                            </tr>
                        }
                        <tr>
                            <td colspan="3" class="text-end"><strong>Tổng thanh toán:</strong></td>
                            <td class="text-end">
                                <h5 class="text-danger mb-0">@Model.TongTien.ToString("N0") đ</h5>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function huyDonHang(maDH) {
            try {
                if (typeof Swal === 'undefined') {
                    console.error('SweetAlert2 chưa được load');
                    alert('Có lỗi xảy ra, vui lòng thử lại sau');
                    return;
                }

                Swal.fire({
                    title: 'Xác nhận hủy đơn hàng?',
                    text: "Bạn có chắc chắn muốn hủy đơn hàng này?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Đồng ý hủy',
                    cancelButtonText: 'Không hủy'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: '@Url.Action("HuyDonHang", "DonHangs_64131236")',
                            type: 'POST',
                            data: {
                                id: maDH,
                                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                            },
                            success: function (result) {
                                if (result.success) {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Thành công!',
                                        text: 'Đơn hàng đã được hủy thành công',
                                        showConfirmButton: false,
                                        timer: 1500
                                    }).then(function () {
                                        location.reload();
                                    });
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Lỗi!',
                                        text: result.message || 'Không thể hủy đơn hàng'
                                    });
                                }
                            },
                            error: function (xhr, status, error) {
                                console.error('Ajax error:', error);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Lỗi!',
                                    text: 'Không thể hủy đơn hàng. Vui lòng thử lại sau.'
                                });
                            }
                        });
                    }
                });
            } catch (error) {
                console.error('Error in huyDonHang:', error);
                alert('Có lỗi xảy ra, vui lòng thử lại sau');
            }
        }

        $(document).ready(function() {
            @if (Model.TrangThai != "Đã hủy")
            {
                <text>
                Swal.fire({
                    icon: 'success',
                    title: 'Đặt hàng thành công!',
                    text: 'Cảm ơn bạn đã đặt hàng. Mã đơn hàng: #' + @Model.MaDH,
                    showConfirmButton: true
                });
                </text>
            }
        });
    </script>
}